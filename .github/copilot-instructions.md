# Copilot Instructions for viking-bio-pwa

## Project Overview

This is an embedded firmware project for the **Raspberry Pi Pico W** that bridges a **Viking Bio 20 pellet burner** to a browser-based dashboard with Web Push notifications. The firmware is written in **C (C11)** and targets the RP2040 microcontroller with CYW43439 Wi-Fi chip.

The project name `viking-bio-pwa` refers to it serving a **Progressive Web App (PWA)** dashboard directly from the Pico W over Wi-Fi via a lightweight HTTP server.

## Repository Structure

```
.
├── CMakeLists.txt          # Main build file (CMake, fetches LittleFS via FetchContent)
├── CMakePresets.json       # CMake presets (pico-default uses Ninja, PICO_BOARD=pico_w)
├── pico_sdk_import.cmake   # Pico SDK bootstrap include
├── cmake/
│   └── gen_web_content.py  # Embeds web files as C string literals (web_content.h)
├── include/                # Public headers for all modules
│   ├── http_server.h
│   ├── push_manager.h
│   ├── wifi_config.h
│   ├── lfs_hal.h
│   ├── serial_handler.h
│   ├── viking_bio_protocol.h
│   ├── flame_counter.h
│   └── version.h
├── src/
│   ├── main.c              # Entry point, main loop, event handling
│   ├── http_server.c       # lwIP httpd CGI/POST handlers, custom filesystem
│   ├── push_manager.c      # VAPID key management, push subscriptions (mbedTLS)
│   ├── wifi_config.c       # AES-128-GCM encrypted WiFi credentials (LittleFS)
│   ├── lfs_hal.c           # LittleFS HAL (flash read/prog/erase via Pico SDK)
│   ├── serial_handler.c    # UART0 receive handler (GP1, 9600 baud)
│   ├── viking_bio_protocol.c # Binary/text protocol parser for burner data
│   ├── flame_counter.c     # Cumulative flame-on time tracking
│   ├── version.c           # Firmware version string printing
│   └── web/
│       ├── index.html      # Dashboard PWA (minified, embedded via gen_web_content.py)
│       ├── sw.js           # Service Worker for offline caching and push
│       └── manifest.json   # PWA manifest
├── platform/
│   ├── lwipopts.h          # lwIP configuration (HTTPD, mDNS, IPv6)
│   ├── mbedtls_config.h    # mbedTLS configuration (ECP P-256, AES-GCM, HKDF)
│   └── fsdata_custom.c     # lwIP httpd stub (custom fs overrides all file serving)
└── .github/
    └── workflows/
        └── build-firmware.yml  # CI: builds firmware with Pico SDK 2.2.0 on ubuntu-latest
```

## Building

### Prerequisites

- **Pico SDK 2.2.0** (set `PICO_SDK_PATH` env var)
- `cmake`, `gcc-arm-none-eabi`, `libnewlib-arm-none-eabi`, `build-essential`
- Python 3 (for `cmake/gen_web_content.py`)

```bash
# Install toolchain
sudo apt-get install cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential

# Clone Pico SDK 2.2.0
git clone --depth 1 --branch 2.2.0 https://github.com/raspberrypi/pico-sdk.git
cd pico-sdk && git submodule update --init && cd ..
export PICO_SDK_PATH=$(pwd)/pico-sdk
```

### Build Command

```bash
mkdir build-pwa && cd build-pwa
cmake .. -DWIFI_SSID="your_network" -DWIFI_PASSWORD="your_password"
make -j$(nproc)
```

- `WIFI_SSID` / `WIFI_PASSWORD` are **optional** compile-time fallbacks; the primary configuration method is USB serial at runtime.
- LittleFS is fetched automatically via `FetchContent` at cmake configure time.
- Output is `build-pwa/viking_bio_pwa-<git-version>.uf2` (and `.elf`, `.bin`, `.hex`).
- The `PICO_BOARD` must be `pico_w` (enforced in CMakeLists.txt).

### CI Build

The GitHub Actions workflow (`.github/workflows/build-firmware.yml`) runs on `ubuntu-latest`, caches the Pico SDK, and builds with `-DWIFI_SSID="ci_build" -DWIFI_PASSWORD="ci_build"`. It triggers on pushes/PRs to `main`/`develop` (ignoring `**.md` and `docs/**`).

**Note:** The workflow uses `paths-ignore: ['**.md', 'docs/**']`, so changes to only `.md` files (including this one) will **not** trigger the firmware build CI.

## Architecture & Key Design Decisions

### HTTP Server

- Uses **lwIP httpd** (`pico_lwip_http`) with a custom virtual filesystem (`fs_open_custom` / `fs_close_custom` in `src/http_server.c`).
- All web files (`index.html`, `sw.js`, `manifest.json`) are **embedded as C string literals** in `web_content.h` (generated by `cmake/gen_web_content.py` at build time).
- **CGI handlers** serve GET endpoints: `/api/data`, `/api/vapid-public-key`, `/api/country`.
- **POST handlers** (`httpd_post_begin` / `httpd_post_receive_data` / `httpd_post_finished`) serve: `/api/subscribe`, `/api/unsubscribe`, `/api/country`.
- The dashboard uses **AJAX polling every 2 seconds** (not Server-Sent Events or WebSockets).
- Dynamic JSON responses are built into static buffers (`s_data_json`, `s_vapid_json`, `s_country_json`) by CGI handlers before lwIP httpd reads them.

### Flash / Persistent Storage

- **LittleFS** filesystem occupies the **last 64 KB** (16 × 4 KB blocks) of flash.
- The HAL is in `src/lfs_hal.c`; it auto-formats on first boot or corruption.
- Files stored:
  - `/vapid.dat` – VAPID EC key pair (magic + private(32) + public(65) + CRC(4) = 105 bytes)
  - `/wifi.dat` – AES-128-GCM encrypted WiFi credentials (magic + nonce + tag + ciphertext = 144 bytes)
  - `/country.dat` – 2-byte Wi-Fi country code (e.g., `SE`)

### WiFi Credentials

- Stored **AES-128-GCM encrypted** in `/wifi.dat`; key derived from the device's unique board ID via `SHA-256(board_id || "VIKINGBIO_WIFIKEY")`.
- **Primary configuration**: USB serial (115200 baud) commands: `SSID=<ssid>`, `PASS=<password>`, `COUNTRY=<CC>`, `STATUS`, `CLEAR`.
- **Secondary (compile-time fallback)**: `-DWIFI_SSID=` / `-DWIFI_PASSWORD=` cmake options (only active if no stored credentials).

### VAPID / Web Push

- VAPID keys (P-256 ECDH) are **generated on first boot** using mbedTLS and stored in `/vapid.dat`.
- `push_manager_notify_all()` currently only logs the notification; outbound HTTPS push to subscription endpoints is a **TODO** (requires additional memory/TLS budget).
- Up to **4 push subscriptions** can be stored in RAM (not persisted across reboots).

### Main Loop

The main loop in `src/main.c` is a **cooperative polling loop**:
1. Feed watchdog (8 s timeout)
2. `cyw43_arch_poll()` – drive Wi-Fi/lwIP stack
3. `process_usb_commands()` – USB serial config
4. `serial_handler_data_available()` / `serial_handler_read()` – Viking Bio UART data
5. Event flags set by a 2-second `repeating_timer`: `EVENT_TIMEOUT_CHECK`, `EVENT_BROADCAST`

### Viking Bio 20 Protocol

Two modes supported (`src/viking_bio_protocol.c`):
- **Binary**: `[0xAA] [FLAGS] [FAN_SPEED] [TEMP_HIGH] [TEMP_LOW] [0x55]`
  - FLAGS bit 0 = flame detected, bits 1-7 = error code
- **Text**: `F:1,S:50,T:75` (Flame 0/1, Speed %, Temperature °C)
- UART0, GPIO1 (RX), 9600 baud, 8N1

### LED Behavior

- **Steady on**: Wi-Fi connected
- **2 Hz blink**: Wi-Fi not connected
- **Short 50 ms blink**: Serial data received from burner

### mDNS

- Device advertises as `viking-bio-XXYY.local` (last 2 bytes of Pico board ID) with `_http._tcp` service on port 80.

## Code Style

Per `.editorconfig`:
- **C/H files**: tabs for indentation, max line length 100
- **CMake files**: 4-space indentation
- **Python files**: 4-space indentation
- **YAML/JSON**: 2-space indentation
- All files: UTF-8, LF line endings, final newline, no trailing whitespace (except `.md`)

Header guards use `#ifndef MODULE_H` / `#define MODULE_H` / `#endif // MODULE_H` style.

## Common Tasks for a Coding Agent

### Adding a new HTTP API endpoint

1. Add a CGI handler function in `src/http_server.c` returning a virtual filename (e.g., `/api_newdata.json`).
2. Register it in `s_cgi_handlers[]`.
3. Add a `fs_open_custom` branch for the virtual filename.
4. Rebuild: `cmake/gen_web_content.py` does not need changes for API-only additions.

### Modifying the dashboard UI

1. Edit `src/web/index.html` (and/or `sw.js`, `manifest.json`).
2. Rebuild – CMake auto-regenerates `web_content.h` via `gen_web_content.py`.
3. Do **not** manually edit `web_content.h`; it is auto-generated.

### Adding a new LittleFS-persisted setting

1. Define a new file path constant (e.g., `#define NEW_SETTING_FILE "/setting.dat"`).
2. Use `lfs_hal_read_file` / `lfs_hal_write_file` / `lfs_hal_delete_file` from `src/lfs_hal.c`.
3. `lfs_hal_init()` must be called and succeed before any file operations (already called in `main()`).

### Changing mbedTLS configuration

Edit `platform/mbedtls_config.h`. The `MBEDTLS_ALLOW_PRIVATE_ACCESS` define is set in `CMakeLists.txt` via `add_compile_definitions` and is required for accessing `MBEDTLS_PRIVATE` struct members.

## Known Limitations / TODOs

- Outbound HTTPS Web Push (`push_manager_notify_all`) logs only; actual delivery to browser push services is not yet implemented (marked `TODO` in `src/push_manager.c`).
- Push subscriptions (up to 4) are stored **in RAM only** and lost on reboot.
- The watchdog reboot (via `watchdog_enable(1, false)`) relies on the watchdog firing within 1 ms; USB stdio output before reboot may not flush.
- IPv4 is not explicitly shown in the STATUS command (only IPv6 link-local addresses are printed).

## Errors Encountered During Onboarding

No build or runtime errors were encountered during exploration of this repository. The CI workflow is well-structured and the build is reproducible as long as `PICO_SDK_PATH` points to Pico SDK 2.2.0.
