<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="/manifest.json">
<title>Viking Bio 20 Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#1a1a2e;color:#eee;min-height:100vh;padding:20px}
h1{text-align:center;color:#e94560;margin-bottom:24px;font-size:1.8em}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;max-width:800px;margin:0 auto}
.card{background:#16213e;border-radius:12px;padding:24px;text-align:center;border:1px solid #0f3460}
.card .label{font-size:.8em;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.card .value{font-size:2em;font-weight:bold;color:#e94560}
.card .unit{font-size:.9em;color:#888;margin-top:4px}
.status{text-align:center;margin:16px auto;max-width:800px;padding:12px;border-radius:8px;font-size:.9em}
.status.ok{background:#0f3460;color:#4ecdc4}
.status.error{background:#3d0000;color:#ff6b6b}
.status.stale{background:#2d2d00;color:#ffd93d}
.status.connecting{background:#1a1a2e;color:#aaa}
.btn{display:inline-block;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-size:.9em;margin:4px}
.btn-push{background:#0f3460;color:#e94560;border:1px solid #e94560}
.btn-push:hover{background:#1a3a6e}
.btn-push.subscribed{background:#0d3d2e;color:#4ecdc4;border-color:#4ecdc4}
.actions{text-align:center;margin:16px auto;max-width:800px}
.flame-on .value{color:#ff6b35}
.flame-off .value{color:#555}
</style>
</head>
<body>
<h1>&#9919; Viking Bio 20</h1>
<div class="status connecting" id="status">Connecting...</div>
<div class="grid">
<div class="card" id="flame-card">
<div class="label">Flame</div>
<div class="value" id="flame">--</div>
<div class="unit">status</div>
</div>
<div class="card">
<div class="label">Fan Speed</div>
<div class="value" id="fan">--</div>
<div class="unit">%</div>
</div>
<div class="card">
<div class="label">Temperature</div>
<div class="value" id="temp">--</div>
<div class="unit">&deg;C</div>
</div>
<div class="card">
<div class="label">Error Code</div>
<div class="value" id="err">--</div>
<div class="unit">code</div>
</div>
</div>
<div class="actions">
<button class="btn btn-push" id="pushBtn" onclick="togglePush()">Enable Push Notifications</button>
</div>
<script>
var es=null,sw=null,sub=null;
function connect(){
  es=new EventSource('/data');
  es.onopen=function(){setStatus('Connected','ok')};
  es.onmessage=function(e){
    try{
      var d=JSON.parse(e.data);
      document.getElementById('flame').textContent=d.flame?'ON':'OFF';
      document.getElementById('flame-card').className='card '+(d.flame?'flame-on':'flame-off');
      document.getElementById('fan').textContent=d.fan;
      document.getElementById('temp').textContent=d.temp;
      document.getElementById('err').textContent=d.err;
      if(d.err>0){setStatus('Error detected: code '+d.err,'error')}
      else if(!d.valid){setStatus('No data from burner','stale')}
      else{setStatus('Live \u2014 last update: '+new Date().toLocaleTimeString(),'ok')}
    }catch(ex){}
  };
  es.onerror=function(){setStatus('Connection lost \u2014 reconnecting...','stale');setTimeout(connect,3000)};
}
function setStatus(msg,cls){
  var el=document.getElementById('status');
  el.textContent=msg;
  el.className='status '+cls;
}
async function togglePush(){
  if(!('serviceWorker' in navigator)||!('PushManager' in window)){
    alert('Push notifications not supported in this browser.');
    return;
  }
  if(sub){
    var ep=sub.endpoint;
    await sub.unsubscribe();
    sub=null;
    await fetch('/unsubscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({endpoint:ep})});
    document.getElementById('pushBtn').textContent='Enable Push Notifications';
    document.getElementById('pushBtn').className='btn btn-push';
    return;
  }
  try{
    var r=await fetch('/vapid-public-key');
    var keyData=await r.json();
    sw=await navigator.serviceWorker.register('/sw.js');
    await navigator.serviceWorker.ready;
    var perm=await Notification.requestPermission();
    if(perm!=='granted'){alert('Notification permission denied.');return;}
    sub=await sw.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlBase64ToUint8Array(keyData.key)});
    var subJson=sub.toJSON();
    await fetch('/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(subJson)});
    document.getElementById('pushBtn').textContent='Push Notifications ON';
    document.getElementById('pushBtn').className='btn btn-push subscribed';
  }catch(e){
    console.error('Push subscription failed:',e);
    alert('Push subscription failed: '+e.message);
  }
}
function urlBase64ToUint8Array(b64){
  var p=b64.replace(/-/g,'+').replace(/_/g,'/');
  while(p.length%4)p+='=';
  var r=atob(p);
  var o=new Uint8Array(r.length);
  for(var i=0;i<r.length;++i)o[i]=r.charCodeAt(i);
  return o;
}
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(function(r){
    return r.pushManager.getSubscription();
  }).then(function(s){
    if(s){sub=s;document.getElementById('pushBtn').textContent='Push Notifications ON';document.getElementById('pushBtn').className='btn btn-push subscribed';}
  });
}
connect();
</script>
</body>
</html>
