<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#1a1a2e">
<link rel="manifest" href="/manifest.json">
<title>Viking Bio 20 Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:#1a1a2e;color:#eee;min-height:100vh;padding:20px}
h1{text-align:center;color:#e94560;margin-bottom:24px;font-size:1.8em}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;max-width:800px;margin:0 auto}
.card{background:#16213e;border-radius:12px;padding:24px;text-align:center;border:1px solid #0f3460}
.card .label{font-size:.8em;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.card .value{font-size:2em;font-weight:bold;color:#e94560}
.card .unit{font-size:.9em;color:#888;margin-top:4px}
.status{text-align:center;margin:16px auto;max-width:800px;padding:12px;border-radius:8px;font-size:.9em}
.status.ok{background:#0f3460;color:#4ecdc4}
.status.error{background:#3d0000;color:#ff6b6b}
.status.stale{background:#2d2d00;color:#ffd93d}
.status.connecting{background:#1a1a2e;color:#aaa}
.btn{display:inline-block;padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-size:.9em;margin:4px}
.btn-push{background:#0f3460;color:#e94560;border:1px solid #e94560}
.btn-push:hover{background:#1a3a6e}
.btn-push.subscribed{background:#0d3d2e;color:#4ecdc4;border-color:#4ecdc4}
.actions{text-align:center;margin:16px auto;max-width:800px}
.settings{text-align:center;margin:16px auto;max-width:800px;padding:16px;background:#16213e;border-radius:12px;border:1px solid #0f3460}
.settings .label{font-size:.8em;color:#aaa;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.settings select{background:#0f3460;color:#eee;border:1px solid #e94560;border-radius:6px;padding:6px 12px;font-size:.9em}
.settings .note{font-size:.75em;color:#888;margin-top:8px}
.flame-on .value{color:#ff6b35}
.flame-off .value{color:#555}
</style>
</head>
<body>
<h1>&#9919; Viking Bio 20</h1>
<div class="status connecting" id="status">Connecting...</div>
<div class="grid">
<div class="card" id="flame-card">
<div class="label">Flame</div>
<div class="value" id="flame">--</div>
<div class="unit">status</div>
</div>
<div class="card">
<div class="label">Fan Speed</div>
<div class="value" id="fan">--</div>
<div class="unit">%</div>
</div>
<div class="card">
<div class="label">Temperature</div>
<div class="value" id="temp">--</div>
<div class="unit">&deg;C</div>
</div>
<div class="card">
<div class="label">Error Code</div>
<div class="value" id="err">--</div>
<div class="unit">code</div>
</div>
<div class="card">
<div class="label">Flame Hours</div>
<div class="value" id="flame-hours">--</div>
<div class="unit">hours</div>
</div>
</div>
<div class="actions">
<button class="btn btn-push" id="pushBtn" onclick="togglePush()">Enable Push Notifications</button>
</div>
<div class="settings">
<div class="label">Wi-Fi Country</div>
<select id="countrySelect" onchange="setCountry(this.value)">
<option value="XX">Worldwide (XX)</option>
<option value="SE">Sweden (SE)</option>
<option value="NO">Norway (NO)</option>
<option value="DK">Denmark (DK)</option>
<option value="FI">Finland (FI)</option>
<option value="DE">Germany (DE)</option>
<option value="GB">United Kingdom (GB)</option>
<option value="FR">France (FR)</option>
<option value="NL">Netherlands (NL)</option>
<option value="US">United States (US)</option>
<option value="CA">Canada (CA)</option>
<option value="AU">Australia (AU)</option>
<option value="JP">Japan (JP)</option>
</select>
<div class="note">Reboot required after changing country</div>
</div>
<script>
var pollTimer=null,sw=null,sub=null;
function poll(){
  fetch('/api/data').then(function(r){return r.json()}).then(function(d){
    document.getElementById('flame').textContent=d.flame?'ON':'OFF';
    document.getElementById('flame-card').className='card '+(d.flame?'flame-on':'flame-off');
    document.getElementById('fan').textContent=d.fan;
    document.getElementById('temp').textContent=d.temp;
    document.getElementById('err').textContent=d.err;
    document.getElementById('flame-hours').textContent=(d.flame_secs/3600).toFixed(1);
    if(d.err>0){setStatus('Error detected: code '+d.err,'error')}
    else if(!d.valid){setStatus('No data from burner','stale')}
    else{setStatus('Live \u2014 last update: '+new Date().toLocaleTimeString(),'ok')}
  }).catch(function(){setStatus('Connection lost \u2014 retrying...','stale')});
}
function startPolling(){
  poll();
  if(pollTimer)clearInterval(pollTimer);
  pollTimer=setInterval(poll,2000);
}
function setStatus(msg,cls){
  var el=document.getElementById('status');
  el.textContent=msg;
  el.className='status '+cls;
}
function loadCountry(){
  fetch('/api/country').then(function(r){return r.json()}).then(function(d){
    var sel=document.getElementById('countrySelect');
    for(var i=0;i<sel.options.length;i++){
      if(sel.options[i].value===d.country){sel.selectedIndex=i;return;}
    }
  }).catch(function(){});
}
function setCountry(code){
  fetch('/api/country',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({country:code})}).then(function(){
    setStatus('Country set to '+code+' \u2014 reboot to apply','ok');
  }).catch(function(){setStatus('Failed to set country','error')});
}
async function togglePush(){
  if(!('serviceWorker' in navigator)||!('PushManager' in window)){
    alert('Push notifications not supported in this browser.');
    return;
  }
  if(sub){
    var ep=sub.endpoint;
    await sub.unsubscribe();
    sub=null;
    await fetch('/api/unsubscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({endpoint:ep})});
    document.getElementById('pushBtn').textContent='Enable Push Notifications';
    document.getElementById('pushBtn').className='btn btn-push';
    return;
  }
  try{
    var r=await fetch('/api/vapid-public-key');
    var keyData=await r.json();
    sw=await navigator.serviceWorker.register('/sw.js');
    await navigator.serviceWorker.ready;
    var perm=await Notification.requestPermission();
    if(perm!=='granted'){alert('Notification permission denied.');return;}
    sub=await sw.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlBase64ToUint8Array(keyData.key)});
    var subJson=sub.toJSON();
    await fetch('/api/subscribe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(subJson)});
    document.getElementById('pushBtn').textContent='Push Notifications ON';
    document.getElementById('pushBtn').className='btn btn-push subscribed';
  }catch(e){
    console.error('Push subscription failed:',e);
    alert('Push subscription failed: '+e.message);
  }
}
function urlBase64ToUint8Array(b64){
  var p=b64.replace(/-/g,'+').replace(/_/g,'/');
  while(p.length%4)p+='=';
  var r=atob(p);
  var o=new Uint8Array(r.length);
  for(var i=0;i<r.length;++i)o[i]=r.charCodeAt(i);
  return o;
}
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(function(r){
    return r.pushManager.getSubscription();
  }).then(function(s){
    if(s){sub=s;document.getElementById('pushBtn').textContent='Push Notifications ON';document.getElementById('pushBtn').className='btn btn-push subscribed';}
  });
}
loadCountry();
startPolling();
</script>
</body>
</html>
